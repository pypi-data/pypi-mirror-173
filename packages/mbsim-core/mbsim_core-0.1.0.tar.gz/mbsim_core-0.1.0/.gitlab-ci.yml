### Gitlab ci file

stages:
  - precommit
  - test
  - docs
  - build
  - publish

default: &default
  image: python:3.9

before_script:
  - python3 -V
  - pip3 install -U pip
  - pip3 install tox

pre-commit check:
  <<: *default
  stage: precommit
  script:
    - tox -e pre

.test: &test
  stage: test

test py35:
  image: python:3.5
  <<: *test
  script:
    - tox -e py35
test py36:
  image: python:3.6
  script:
    - tox -e py36
  <<: *test
test py37:
  image: python:3.7
  script:
    - tox -e py37
  <<: *test
test py38:
  image: python:3.8
  script:
    - tox -e py38
  <<: *test
test py39:
  image: python:3.9
  script:
    - tox -e py39
  <<: *test


pages:
  <<: *default
  stage: docs
  script:
    - tox -e docs
    - mv docs/_build/html public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG


build package:
  <<: *default
  stage: build
  script:
    - tox -e build
  artifacts:
    paths:
      - dist
  rules:
    - if: $CI_COMMIT_TAG


upload to pypi:
  <<: *default
  stage: publish
  script:
    - tox -e publish -- --repository pypi
  dependencies:
    - build package
  rules:
    - if: $CI_COMMIT_TAG

upload to gitlab:
  <<: *default
  stage: publish
  script:
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token tox -e publish -- --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi
  dependencies:
    - build package
  rules:
    - if: $CI_COMMIT_TAG
